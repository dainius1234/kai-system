version: '3.8'

networks:
  sovereign-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

services:
  postgres:
    image: postgres:15-alpine
    container_name: sovereign-postgres
    environment:
      POSTGRES_DB: sovereign
      POSTGRES_USER: keeper
      POSTGRES_PASSWORD: "localdev"
    volumes:
      - postgres_data:/var/lib/postgresql/data:rw
    networks:
      sovereign-net:
        ipv4_address: 172.20.0.2

  redis:
    image: redis:7-alpine
    container_name: sovereign-redis
    networks:
      sovereign-net:
        ipv4_address: 172.20.0.4

  tool-gate:
    build:
      context: .
      dockerfile: tool-gate/Dockerfile
    container_name: sovereign-tool-gate
    environment:
      MODE: "WORK"
      REQUIRED_CONFIDENCE: "0.7"
      NONCE_TTL_SECONDS: "300"
    ports:
      - "8000:8000"
    networks:
      sovereign-net:
        ipv4_address: 172.20.0.3
    depends_on:
      - postgres

  memu-core:
    build:
      context: .
      dockerfile: memu-core/Dockerfile
    container_name: sovereign-memu-core
    environment:
      MEMU_URL: http://memu-core:8001
      MAX_MEMORY_RECORDS: "5000"
    ports:
      - "8001:8001"
    networks:
      sovereign-net:
        ipv4_address: 172.20.0.5
    depends_on:
      - redis

  heartbeat:
    build:
      context: .
      dockerfile: heartbeat/Dockerfile
    container_name: sovereign-heartbeat
    environment:
      MEMU_URL: http://memu-core:8001
      CHECK_INTERVAL: "60"
      ALERT_WINDOW: "300"
    ports:
      - "8010:8010"
    networks:
      sovereign-net:
        ipv4_address: 172.20.0.6
    depends_on:
      - memu-core

  dashboard:
    build:
      context: .
      dockerfile: dashboard/Dockerfile
    container_name: sovereign-dashboard
    environment:
      TOOL_GATE_URL: http://tool-gate:8000
      MEMU_URL: http://memu-core:8001
      HEARTBEAT_URL: http://heartbeat:8010
    ports:
      - "8080:8080"
    networks:
      sovereign-net:
        ipv4_address: 172.20.0.7
    depends_on:
      - tool-gate
      - memu-core
      - heartbeat

volumes:
  postgres_data:

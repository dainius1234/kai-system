version: '3.8'

networks:
  sovereign-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

services:
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: sovereign
      POSTGRES_USER: keeper
      POSTGRES_PASSWORD: "localdev"
    volumes:
      - postgres_data:/var/lib/postgresql/data:rw
    networks:
      sovereign-net:
        ipv4_address: 172.20.0.2

  redis:
    image: redis:7-alpine
    networks:
      sovereign-net:
        ipv4_address: 172.20.0.4

  tool-gate:
    build:
      context: .
      dockerfile: tool-gate/Dockerfile
    environment:
      MODE: "WORK"
      REQUIRED_CONFIDENCE: "0.7"
    ports:
      - "8000:8000"
    networks:
      sovereign-net:
        ipv4_address: 172.20.0.3
    depends_on:
      - postgres

  memu-core:
    build:
      context: .
      dockerfile: memu-core/Dockerfile
    environment:
      MEMU_URL: http://memu-core:8001
      MAX_MEMORY_RECORDS: "5000"
      REDIS_URL: redis://redis:6379
    ports:
      - "8001:8001"
    networks:
      sovereign-net:
        ipv4_address: 172.20.0.5
    depends_on:
      - redis
      - tool-gate

  heartbeat:
    build:
      context: .
      dockerfile: heartbeat/Dockerfile
    environment:
      MEMU_URL: http://memu-core:8001
      CHECK_INTERVAL: "60"
      ALERT_WINDOW: "300"
    ports:
      - "8010:8010"
    networks:
      sovereign-net:
        ipv4_address: 172.20.0.6
    depends_on:
      - memu-core

  dashboard:
    build:
      context: .
      dockerfile: dashboard/Dockerfile
    environment:
      TOOL_GATE_URL: http://tool-gate:8000
      MEMU_URL: http://memu-core:8001
      LANGGRAPH_URL: http://langgraph:8007
      EXECUTOR_URL: http://executor:8002
      HEARTBEAT_URL: http://heartbeat:8010
      SUPERVISOR_URL: http://supervisor:8051
    ports:
      - "8080:8080"
    networks:
      sovereign-net:
        ipv4_address: 172.20.0.7
    depends_on:
      - tool-gate
      - memu-core
      - heartbeat

  supervisor:
    build:
      context: .
      dockerfile: supervisor/Dockerfile
    environment:
      SWEEP_INTERVAL: "30"
    ports:
      - "8051:8051"
    networks:
      sovereign-net:
        ipv4_address: 172.20.0.8
    depends_on:
      - memu-core
      - tool-gate

  verifier:
    build:
      context: .
      dockerfile: verifier/Dockerfile
    environment:
      MEMU_URL: http://memu-core:8001
    ports:
      - "8052:8052"
    networks:
      sovereign-net:
        ipv4_address: 172.20.0.9
    depends_on:
      - memu-core

  fusion-engine:
    build:
      context: .
      dockerfile: fusion-engine/Dockerfile
    environment:
      VERIFIER_URL: http://verifier:8052
    ports:
      - "8053:8053"
    networks:
      sovereign-net:
        ipv4_address: 172.20.0.10
    depends_on:
      - verifier

  langgraph:
    build:
      context: .
      dockerfile: langgraph/Dockerfile
    environment:
      MEMU_URL: http://memu-core:8001
      TOOL_GATE_URL: http://tool-gate:8000
      REDIS_URL: redis://redis:6379
    ports:
      - "8007:8007"
    networks:
      sovereign-net:
        ipv4_address: 172.20.0.11
    depends_on:
      - memu-core
      - redis

  executor:
    build:
      context: .
      dockerfile: executor/Dockerfile
    environment:
      TOOL_GATE_URL: http://tool-gate:8000
    ports:
      - "8002:8002"
    networks:
      sovereign-net:
        ipv4_address: 172.20.0.12
    depends_on:
      - tool-gate

  audio-service:
    build:
      context: .
      dockerfile: perception/audio/Dockerfile
    ports:
      - "8030:8030"
    networks:
      sovereign-net:
        ipv4_address: 172.20.0.13

  camera-service:
    build:
      context: .
      dockerfile: perception/camera/Dockerfile
    ports:
      - "8040:8040"
    networks:
      sovereign-net:
        ipv4_address: 172.20.0.14

  kai-advisor:
    build:
      context: .
      dockerfile: kai-advisor/Dockerfile
    ports:
      - "8090:8090"
    networks:
      sovereign-net:
        ipv4_address: 172.20.0.15

  tts-service:
    build:
      context: .
      dockerfile: output/tts/Dockerfile
    ports:
      - "8031:8031"
    networks:
      sovereign-net:
        ipv4_address: 172.20.0.16

  avatar-service:
    build:
      context: .
      dockerfile: output/avatar/Dockerfile
    ports:
      - "8081:8081"
    networks:
      sovereign-net:
        ipv4_address: 172.20.0.17

volumes:
  postgres_data:
